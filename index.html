<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DPMods Admin Panel</title>
<style>
body { background:#111; color:#fff; font-family:Arial; }
.user-item { padding:10px; border-bottom:1px solid #333; }
</style>
</head>

<body>

<h1>DPMods Admin Panel</h1>

<div id="userList">Loading...</div>

<!-- Password Modal -->
<div id="passwordModal" style="display:none; background:#0008; position:fixed; top:0; left:0; width:100%; height:100%; align-items:center; justify-content:center;">
    <div style="background:#222; padding:20px; border-radius:8px;">
        <h3>Enter Admin Password</h3>
        <input type="password" id="adminPasswordInput">
        <button onclick="handlePasswordConfirmation()">Confirm</button>
    </div>
</div>

<div id="toast" style="color:#fff; background:#333; padding:10px; margin-top:20px; display:none;"></div>

<script>
// =============================
// GITHUB CONFIG
// =============================
const GITHUB_OWNER = "ahmedbrand";     // GitHub username
const GITHUB_REPO = "ahmedcheater";    // Repo name
const FILE_PATH = "Key.json";          // File in repo

const GITHUB_BRANCH = "main";          // or "master"
const GITHUB_TOKEN = "YOUR_GITHUB_TOKEN"; // <<< PUT YOUR TOKEN HERE

const API_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${FILE_PATH}`;

const ADMIN_PASSWORD = "bro2025";
let configData = {};
let latestSha = "";  // GitHub requires file SHA to update

// Toast Helper
function showToast(msg) {
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.style.display = "block";
    setTimeout(() => t.style.display = "none", 3000);
}

// =============================
// LOAD CONFIG FROM GITHUB
// =============================
async function loadConfig() {
    try {
        const res = await fetch(`${API_URL}?ref=${GITHUB_BRANCH}`, {
            headers: {
                "Authorization": `Bearer ${GITHUB_TOKEN}`,
                "Accept": "application/vnd.github+json"
            }
        });

        if (!res.ok) throw new Error("GitHub Read Failed");

        const file = await res.json();
        latestSha = file.sha;

        const jsonDecoded = atob(file.content);
        configData = JSON.parse(jsonDecoded);

        renderIDs();
        showToast("Config loaded.");
    }
    catch (err) {
        console.error(err);
        showToast("Failed to load config. Check Token/Network.");
        document.getElementById("userList").innerHTML = "Load Error.";
    }
}

// =============================
// SAVE CONFIG TO GITHUB
// =============================
async function saveConfig() {
    try {
        const encodedContent = btoa(JSON.stringify(configData, null, 2));

        const res = await fetch(API_URL, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${GITHUB_TOKEN}`,
                "Accept": "application/vnd.github+json",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: "Update Key.json from admin panel",
                content: encodedContent,
                branch: GITHUB_BRANCH,
                sha: latestSha
            })
        });

        if (!res.ok) throw new Error("GitHub Update Failed");

        showToast("Saved successfully!");
        loadConfig();
    }
    catch (err) {
        console.error(err);
        showToast("Save Failed.");
    }
}

// =============================
// PASSWORD CONFIRMATION
// =============================
function handlePasswordConfirmation() {
    const pass = document.getElementById("adminPasswordInput").value;
    document.getElementById("adminPasswordInput").value = "";
    document.getElementById("passwordModal").style.display = "none";

    if (pass !== ADMIN_PASSWORD) return showToast("Incorrect Password.");

    saveConfig();
}

// =============================
// UI RENDER
// =============================
function renderIDs() {
    const list = document.getElementById("userList");
    const items = configData.credentials || [];

    list.innerHTML = "";

    items.forEach(u => {
        const div = document.createElement("div");
        div.className = "user-item";
        div.innerHTML = `
            <b>${u.username}</b> — Expire: ${u.expire_date} — Limit: ${u.device_limit}
        `;
        list.appendChild(div);
    });
}

// =============================
// INITIAL LOAD
// =============================
loadConfig();

</script>
</body>
</html>
